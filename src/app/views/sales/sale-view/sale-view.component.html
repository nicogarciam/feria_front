<mat-toolbar color="primary" class="booking-toolbar" [@animate]="{value:'*',params:{delay:'300ms',y:'50px'}}">
    <button mat-icon-button matTooltip="{{ 'mark.as.important' | translate}}" class="">
        <mat-icon>folder_special</mat-icon>
    </button>
    <button mat-icon-button matTooltip="{{ 'save' | translate}}" class="" (click)="saveSale()">
        <mat-icon>save</mat-icon>
    </button>
    <button mat-icon-button matTooltip="{{ 'delete' | translate}}">
        <mat-icon>delete</mat-icon>
    </button>
</mat-toolbar>

<div fxLayout="row wrap">

    <!-- DETAIL -->
    <div fxLayout="column" fxFlex="100" fxFlex.gt-md="60">
        <!-- DETAIL -->
        <mat-card class="p-1">
            <mat-card-title>
                <div class="card-title-text" fxLayout="row" fxLayoutAlign="space-between center">
                    {{'sales' | translate }}
                    <span fxFlex></span>
                    <mat-form-field class="p-0 ml-1" style="width: 140px">

                        <mat-select [formControl]="new_state" >
                            <mat-option *ngFor="let st of saleStates" [value]="st.id">
                                {{ st.name | translate}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </mat-card-title>

            <mat-card-content class="p-05 mb-0 ">
                <div fxLayout="row wrap" fxLayoutAlign="space-between start">
                    <!--    DETAIL    -->
                    <div class="pr-1"  fxLayout="column" fxLayoutAlign="start stretch" fxFlex="50">

                        <div>
                            <ng-container *ngIf="_sale?.customer" >
                                <div fxLayout="column" style="width: 150px">
                                    {{ _sale.customer?.name}}
                                </div>
                                <div fxLayout="column" style="width: 200px">
                                    <small>{{ _sale.customer?.phone}}</small>
                                    <small>{{ _sale.customer?.email}}</small>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="_sale?.customer" >
                                <div fxLayout="column" style="width: 150px">
                                    {{ _sale.customer?.name}}
                                </div>
                                <div fxLayout="column" style="width: 200px">
                                    <small>{{ _sale.customer?.phone}}</small>
                                    <small>{{ _sale.customer?.email}}</small>
                                </div>
                            </ng-container>
                        </div>


                        <div class="border-bottom pb-1 mb-1" fxLayout="row" fxLayoutAlign="space-between center" fxFlex="100">

                        </div>

                        <!-- PRODUCTS -->
                        <mat-card class="m-0" *ngIf="_sale.products?.length == 0">
                            <h4>{{'no.products.found' | translate }}</h4>
                        </mat-card>
                        <div class="border-bottom pb-1 mb-1" *ngFor="let prod of _sale.products">
                            <div fxLayout="row wrap" fxLayout="center" class="font-weight-bold">
                                <div>{{prod.name}}</div>
                                <div  class="pl-1">{{prod.category?.name}}</div>
                                <div fxFlex></div>
                                <mat-icon class="mr-1">groups</mat-icon>
                                <div class="text-blue">{{prod.color}}</div>
                            </div>
                            <div fxLayout="row wrap" class="text-muted">
                                <small>{{prod.code}}</small>
                                <span fxFlex></span>
                                <small class="text-green">{{prod.cost}}</small>
                            </div>
                        </div>

                        <p>
                            {{_sale.note}}
                        </p>
                    </div>
                    <!--  BILLING -->
                    <div class="pl-1"  fxLayout="column" fxLayoutAlign="start stretch"  fxFlex="50">
                        <div class="mb-1 font-weight-bold" style="font-size: 1rem" fxLayout="row wrap" fxLayoutAlign="space-between center">
                            {{ 'billing' | translate }}
                        </div>

                        <div class="pb-05" fxLayout="row" fxLayoutAlign="space-between center">
                            <div>
                                {{ 'accommodation' | translate }}
                            </div>
                            <span>{{_sale.total_price | currency: 'ARS': '$'}}</span>
                        </div>

                        <div class="pb-05" fxLayout="row" fxLayoutAlign="space-between center">
                            <div>
                                {{ 'discount' | translate }}
                            </div>
                            <span>{{_sale.coupon_code}}</span>
                            <span>{{_sale.discount}}</span>
                        </div>


                        <div class="border-bottom pb-1 mb-1 fz-1 fw-400" fxLayout="row" fxLayoutAlign="space-between center">
                            <div>
                                {{ 'total' | translate }}
                            </div>
                            <span>{{_sale.total_price | currency: 'ARS': '$'}}</span>
                        </div>

                        <div class="border-bottom pb-1 mb-1 fz-1 fw-400" fxLayout="row" fxLayoutAlign="space-between center">
                            <div>
                                {{ 'paid' | translate }}
                            </div>
                            <span>{{_sale.total_paid | currency: 'ARS': '$'}}</span>
                        </div>

                        <div class="border-bottom pb-1 mb-1 fz-1 fw-400" fxLayout="row" fxLayoutAlign="space-between center">
                            <div>
                                {{ 'to.pay' | translate }}
                            </div>
                            <span>{{ _sale.total_price - _sale.total_paid | currency: 'ARS': '$'}}</span>
                        </div>
                    </div>

                </div>
            </mat-card-content>

            <mat-accordion>
                <mat-expansion-panel>
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <div fxLayout="row" fxLayoutAlign="start center">
                                <div class="mr-1">{{_sale.sale_state?.state | translate}}</div>
                                <div>{{ 'from' | translate}} {{ _sale.sale_state?.date_from | momentFormat : 'dd/MM/yyyy hh:mm:ss'}}</div>
                            </div>

                        </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="timeline">
                        <div class="timeline-item" *ngFor="let state of _saleStates">
                            <div class="timeline-badge">
                                <mat-icon class="icon-badge mat-bg-warn {{state.state}}">settings</mat-icon>
                            </div>
                            <div class="timeline-body">
                                <div class="timeline-body-top" fxLayout="row">
                                    <b> {{state.date_from | momentFormat : 'dd/MM/yyyy hh:mm:ss'}}
                                        - {{state.state | translate}} </b> &nbsp;
                                    <span class="text-muted mr-1 ml-1"> {{state.date_from?.toDate() | relativeTime}}</span>
                                    <b *ngIf="state.date_to"> {{ 'to' | translate }} {{state.date_to | momentFormat : 'dd/MM/yyyy hh:mm:ss'}}</b>
                                </div>
                                <div class="timeline-body-content">
                                    <p>{{state.event | translate}}</p>
                                    <span class="text-muted">{{state.user_email}} </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-expansion-panel>

            </mat-accordion>
        </mat-card>
    </div>

    <!-- customers--><!-- FEEs--><!-- PAYS-->
    <div fxLayout="column" fxFlex="100" fxFlex.gt-md="40">
        <!-- customers-->
        <mat-card class="p-0">
            <mat-card-title >
                <div class="card-title-text">
                    <mat-icon class="mr-05">family_restroom</mat-icon>
                    {{'customer' | translate }}
                    <span fxFlex></span>

                </div>
                <mat-divider></mat-divider>
            </mat-card-title>
            <mat-card-content class="p-0">
                <mat-list class="compact-list mb-1">
                    <mat-list-item *ngIf="loadingCustomer">
                        <mat-spinner diameter="16"></mat-spinner>
                    </mat-list-item>
                    <mat-list-item class="" *ngIf="!loadingCustomer && !_sale.customer">
                        <h4>{{'no.customer.found' | translate }}</h4>
                    </mat-list-item>

                </mat-list>
            </mat-card-content>
        </mat-card>
        <!-- END customers-->

        <!-- PAYS-->
        <mat-card class="p-0" [@animate]="{value:'*',params:{scale:'.9',delay:'300ms'}}">
            <mat-card-title class="">
                <div class="card-title-text">
                    <mat-icon class="mr-05">payments</mat-icon>

                    {{'pays' | translate }}
                    <span fxFlex></span>
                    <button mat-icon-button class="card-control" (click)="getSalePays()">
                        <mat-icon>refresh</mat-icon>
                    </button>
                    <button mat-icon-button (click)="addPayPopup()" class="card-control">
                        <mat-icon>add_circle_outline</mat-icon>
                    </button>
                </div>
                <mat-divider></mat-divider>
            </mat-card-title>
            <mat-card-content class="p-0">
<!--                <mat-list class="compact-list mb-1">-->
<!--                    <mat-list-item *ngIf="loadingPays">-->
<!--                        <mat-spinner diameter="16"></mat-spinner>-->
<!--                    </mat-list-item>-->
<!--                    <mat-list-item class="" *ngIf="!loadingPays && _booking.pays?.length == 0">-->
<!--                        <h4>{{'no.pays.found' | translate }}</h4>-->
<!--                    </mat-list-item>-->
<!--                    <mat-list-item *ngFor="let p of _booking.pays">-->
<!--                        <div fxLayout="row" fxFlex="100" fxLayoutAlign="space-between center">-->
<!--                            <small fxFlex>{{ p?.pay_date | date : 'dd/MM/yyyy'}}</small>-->
<!--                            <small fxFlex>{{ p?.type | translate }} </small>-->
<!--                            <small fxFlex>{{ p?.concept}} </small>-->
<!--                            <small class="text-muted mr-1" fxFlex>{{ p?.amount  | currency:'$'}}</small>-->
<!--                            <button mat-icon-button class="card-control" color="warn" (click)="deletePay(p)">-->
<!--                                <mat-icon>delete</mat-icon>-->
<!--                            </button>-->
<!--                        </div>-->
<!--                    </mat-list-item>-->
<!--                </mat-list>-->

                <ngx-datatable
                        class="material ml-0 mr-0 fullscreen"
                        [rows]="_sale.pays"
                        [columnMode]="'force'"
                        [headerHeight]="40"
                        [footerHeight]="40"
                        [scrollbarH]="false"
                        [limit]="10"
                        [rowHeight]="40"
                        [loadingIndicator]="loadingPays"
                        [messages]="{emptyMessage: 'Nada por aca' }"
                >
                    <ngx-datatable-column name="{{'date' | translate }}" prop="pay_date"  [width]="80">
                        <ng-template ngx-datatable-cell-template let-row="row">
                            <span> {{ row?.pay_date | date : 'dd/MM/yyyy'}} </span>
                        </ng-template>
                    </ngx-datatable-column>
                    <ngx-datatable-column name="{{'type' | translate }}" prop="type"  [width]="80">
                        <ng-template ngx-datatable-cell-template let-row="row">
                            <span>{{ row?.type | translate }} </span>
                        </ng-template>
                    </ngx-datatable-column>
                    <ngx-datatable-column class="align-right" name="{{'amount' | translate }}" prop="amount" >
                        <ng-template ngx-datatable-cell-template let-row="row">
                            <span>{{ row?.amount  | currency:'$'}} </span>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="{{'actions' | translate }}" [width]="20">
                        <ng-template let-rowIndex="rowIndex" let-row="row" ngx-datatable-cell-template>
                            <button mat-icon-button class="card-control" color="warn">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </ng-template>
                    </ngx-datatable-column>
                </ngx-datatable>



            </mat-card-content>
        </mat-card>
        <!-- END PAYS-->
    </div>
</div>
